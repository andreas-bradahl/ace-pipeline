apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: clone-repos
spec:
  params:
    - name: event-repo-name
    - name: github-user
    - name: github-branch
    - name: scripts-dir
    - name: repo-list
  workspaces:
    - name: sources
  steps:
  
    - name: get-build-repo
      image: image-registry.openshift-image-registry.svc:5000/cicd/ubi8-tip
      workingDir: /workspace/sources
      script: |
        #!/bin/bash

        set -eu

        echo "Event repo name: $(params.event-repo-name)"
        echo "GitHub user: $(params.github-user)"

        # TODO: build repo needs to be transfered to user:tineikt
        git clone https://github.com/andreasbradahl-avella/ace-pipelines-build-repo.git build-repo


        echo $(./$(params.scripts-dir)/get_topic.sh $GH_TOKEN $(params.github-user) $(params.event-repo-name)) > topic.txt

    - name: get-repos-with-this-topic
      image: image-registry.openshift-image-registry.svc:5000/cicd/ubi8-tip
      workingDir: /workspace/sources
      script: |
        #!/bin/bash

        set -eu

        SCRIPTS_DIR="build-repo/scripts"
        REPO_LIST="repos_list.json"
        TOPIC=$(./$SCRIPTS_DIR/get_topic.sh $GH_TOKEN $(params.github-user) $(params.event-repo-name))

        mkdir -p common-workspace

        if [ -z "$TOPIC" ]; then
          echo "No topic with pod bundle name found for this repo. Cloning event repo only..."
          git clone -b $(params.github-branch) https://github.com/$(params.github-user)/$(params.event-repo-name).git common-workspace/$(params.event-repo-name)
        else
          ./$(params.scripts-dir)/get_repo_list_for_topic.sh $GH_TOKEN $(params.github-user) $TOPIC $(params.repo-list)

          echo "Found $(jq length $(params.repo-list)) repos with bundle topic name '$TOPIC'."

          # For each repo in repo list, fetch transitive dependencies
          jq -cr '.[]' $(params.repo-list) | while read repo; do
            python3 $(params.scripts-dir)/fetch_dependencies_recursively.py $repo $(params.github-branch) "/workspace/sources/common-workspace"
          done
        fi

        find /workspace -type d
      env:
      - name: GH_TOKEN
        valueFrom:
          secretKeyRef:
            name: tip-git-basic-auth
            key: password