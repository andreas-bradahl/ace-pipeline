apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: create-and-deploy-integration-server
spec:
  params:
    - name: image_url
      type: string
      description: The URL of the application image
    - name: release_name
      type: string
      description: The release name of the application
    - name: namespace
      type: string
      description: The namespace (OCP project) the application resides in
    - name: generated_name
      type: string
      description: The application name generated by the pipeline
  steps:
    - name: create-is-manifest
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      script: |
        echo "Creating IntegrationServer manifest"
        cat << EOF > integrationserver.yaml
        apiVersion: appconnect.ibm.com/v1beta1
        kind: IntegrationServer
        metadata:
          name: $(params.release_name)
        spec:
          version: 11.0.0
          pod:
            containers:
              runtime:
                image: $(params.image_url)
              license:
                accept: true
                license: L-APEH-BSVCHU
                use: CloudPakForIntegrationNonProduction
              barURL: ’’
              designerFlowsOperationMode: disabled
              service:
            endpointType: http
        useCommonServices: false
        replicas: 1
        EOF
    - name: deploy-is-manifest
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
        echo "Applying IntegrationServer manifest to OpenShift cluster"
        oc apply -f integrationserver.yaml
